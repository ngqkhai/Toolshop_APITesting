name: API Testing Pipeline - Sprint5 with Bugs

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'sprint5-with-bugs/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'sprint5-with-bugs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - product-management
          - user-management
          - brand-management
          - favorites-management

env:
  SPRINT_DIR: sprint5-with-bugs
  DOCKER_COMPOSE_FILE: docker-compose.yml
  BASE_URL: http://localhost:8091

jobs:
  setup-environment:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      environment-ready: ${{ steps.health-check.outputs.ready }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Project Structure
        working-directory: ${{ env.SPRINT_DIR }}
        run: |
          echo "📁 Current directory contents:"
          ls -la
          echo ""
          echo "🔍 Checking for required files:"
          test -f docker-compose.yml && echo "✅ docker-compose.yml exists" || echo "❌ docker-compose.yml missing"
          test -f API/.env.example && echo "✅ API/.env.example exists" || echo "❌ API/.env.example missing"
          test -f Toolshop_APITesting.postman_collection.json && echo "✅ Postman collection exists" || echo "❌ Postman collection missing"

      - name: Set up Docker Environment
        working-directory: ${{ env.SPRINT_DIR }}
        run: |
          # Set environment variable for sprint folder
          echo "SPRINT=sprint5-with-bugs" > .env
          
          # Ensure Laravel has correct database configuration
          cp API/.env.example API/.env
          echo "DB_CONNECTION=mysql" >> API/.env
          echo "DB_HOST=mariadb" >> API/.env
          echo "DB_PORT=3306" >> API/.env
          echo "DB_DATABASE=toolshop" >> API/.env
          echo "DB_USERNAME=user" >> API/.env
          echo "DB_PASSWORD=root" >> API/.env
          echo "APP_KEY=base64:hJawExRAnwWOUI0a/YBWH+yRHJWCKYpwItOUFQdcFo4=" >> API/.env
          echo "JWT_SECRET=XVVuj9s7byIX8XPNWt0aYOsFjmc4JZQmE2wR7h9IJXoEOWXwk6o6wM8AKUL7jUTy" >> API/.env
          
          # Start the application stack
          echo "🚀 Starting Docker services..."
          docker compose up -d --build
          
          # Show running containers
          echo "📋 Running containers:"
          docker compose ps
          
          # Wait for services to be ready
          echo "⏳ Waiting for services to start..."
          sleep 90

      - name: Setup Database
        working-directory: ${{ env.SPRINT_DIR }}
        run: |
          echo "🗄️ Setting up database..."
          
          # Wait for MariaDB service to be ready first
          echo "⏳ Waiting for MariaDB service..."
          for i in {1..30}; do
            if docker compose exec -T mariadb mysqladmin ping -h localhost -u root -proot --silent; then
              echo "✅ MariaDB service is ready!"
              break
            elif [ $i -eq 30 ]; then
              echo "❌ MariaDB service failed to start after 30 attempts"
              docker compose logs mariadb
              exit 1
            else
              echo "MariaDB not ready, waiting 10 seconds... (attempt $i/30)"
              sleep 10
            fi
          done
          
          # Wait for Laravel application to be ready
          echo "⏳ Waiting for Laravel application..."
          for i in {1..30}; do
            if docker compose exec -T laravel-api php -v > /dev/null 2>&1; then
              echo "✅ Laravel application is ready!"
              break
            elif [ $i -eq 30 ]; then
              echo "❌ Laravel application failed to start after 30 attempts"
              docker compose logs laravel-api
              exit 1
            else
              echo "Laravel application not ready, waiting 10 seconds... (attempt $i/30)"
              sleep 10
            fi
          done
          
          # Test database connection through Laravel
          echo "⏳ Testing database connection through Laravel..."
          for i in {1..20}; do
            if docker compose exec -T laravel-api php artisan migrate:status > /dev/null 2>&1; then
              echo "✅ Database connection established!"
              break
            elif [ $i -eq 20 ]; then
              echo "❌ Database connection failed after 20 attempts"
              echo "Checking Laravel logs..."
              docker compose logs laravel-api
              echo "Checking MariaDB logs..."
              docker compose logs mariadb
              exit 1
            else
              echo "Database connection not ready, waiting 5 seconds... (attempt $i/20)"
              sleep 5
            fi
          done
          
          # Run migrations
          echo "🔄 Running database migrations..."
          docker compose exec -T laravel-api php artisan migrate --force
          
          # Run seeders
          echo "🌱 Seeding database..."
          docker compose exec -T laravel-api php artisan db:seed --force
          
          # Clear caches
          echo "🧹 Clearing caches..."
          docker compose exec -T laravel-api php artisan cache:clear
          docker compose exec -T laravel-api php artisan config:clear
          
          echo "✅ Database setup complete!"

      - name: Health Check Services
        id: health-check
        run: |
          # Check if web service is responding
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8091/products > /dev/null 2>&1; then
              echo "✅ Application is ready!"
              echo "ready=true" >> $GITHUB_OUTPUT
              break
            fi
            
            echo "⏳ Waiting for application... (attempt $((attempt + 1))/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Application failed to start"
            echo "ready=false" >> $GITHUB_OUTPUT
            docker compose logs
            exit 1
          fi

      - name: Verify Database Connection
        working-directory: ${{ env.SPRINT_DIR }}
        run: |
          # Check if we can connect to the database
          docker compose exec -T laravel-api php artisan migrate:status

  api-tests:
    name: Run API Tests
    runs-on: ubuntu-latest
    needs: setup-environment
    if: needs.setup-environment.outputs.environment-ready == 'true'
    
    strategy:
      matrix:
        test-suite:
          - name: "Product Management"
            folder: "Product Management"
          - name: "User Management" 
            folder: "User Management"
          - name: "Favorites Management"
            folder: "Favorites Management"
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Newman (Postman CLI)
        run: |
          npm install -g newman
          npm install -g newman-reporter-html
          npm install -g newman-reporter-htmlextra

      - name: Wait for Application Ready
        run: |
          # Wait for application to be ready
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f ${{ env.BASE_URL }}/products > /dev/null 2>&1; then
              echo "✅ Application is ready!"
              break
            fi
            
            echo "⏳ Waiting for application... (attempt $((attempt + 1))/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Application failed to start"
            exit 1
          fi

      - name: Get Authentication Tokens
        id: auth
        run: |
          # Get admin token
          ADMIN_RESPONSE=$(curl -s -X POST ${{ env.BASE_URL }}/users/login \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@practicesoftwaretesting.com","password":"welcome01"}')
          
          ADMIN_TOKEN=$(echo $ADMIN_RESPONSE | jq -r '.access_token // empty')
          
          # Get regular user token  
          USER_RESPONSE=$(curl -s -X POST ${{ env.BASE_URL }}/users/login \
            -H "Content-Type: application/json" \
            -d '{"email":"customer@practicesoftwaretesting.com","password":"welcome01"}')
          
          USER_TOKEN=$(echo $USER_RESPONSE | jq -r '.access_token // empty')
          
          # Validate tokens
          if [ -z "$ADMIN_TOKEN" ] || [ "$ADMIN_TOKEN" = "null" ]; then
            echo "❌ Failed to get admin token"
            echo "Admin response: $ADMIN_RESPONSE"
            exit 1
          else
            echo "✅ Got admin token"
          fi
          
          if [ -z "$USER_TOKEN" ] || [ "$USER_TOKEN" = "null" ]; then
            echo "❌ Failed to get user token"  
            echo "User response: $USER_RESPONSE"
            exit 1
          else
            echo "✅ Got user token"
          fi
          
          echo "admin_token=$ADMIN_TOKEN" >> $GITHUB_OUTPUT
          echo "user_token=$USER_TOKEN" >> $GITHUB_OUTPUT

      - name: Run ${{ matrix.test-suite.name }} Tests
        working-directory: ${{ env.SPRINT_DIR }}
        run: |
          # Create reports directory
          mkdir -p reports
          
          newman run Toolshop_APITesting.postman_collection.json \
            --folder "${{ matrix.test-suite.folder }}" \
            --env-var "baseUrl=${{ env.BASE_URL }}" \
            --env-var "admin_token=${{ steps.auth.outputs.admin_token }}" \
            --env-var "user_token=${{ steps.auth.outputs.user_token }}" \
            --env-var "productId=1" \
            --env-var "userId=2" \
            --env-var "brandId=1" \
            --env-var "otherUserId=3" \
            --reporters cli,html,htmlextra \
            --reporter-html-export "reports/report-${{ matrix.test-suite.name }}.html" \
            --reporter-htmlextra-export "reports/detailed-report-${{ matrix.test-suite.name }}.html" \
            --reporter-htmlextra-title "${{ matrix.test-suite.name }} API Test Report" \
            --verbose

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-reports-${{ matrix.test-suite.name }}
          path: ${{ env.SPRINT_DIR }}/reports/
          retention-days: 30

  full-regression-test:
    name: Full Regression Test Suite
    runs-on: ubuntu-latest
    needs: setup-environment
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_suite == 'all'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Newman
        run: |
          npm install -g newman newman-reporter-html newman-reporter-htmlextra

      - name: Wait for Application Ready
        run: |
          # Wait for application to be ready
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f ${{ env.BASE_URL }}/products > /dev/null 2>&1; then
              echo "✅ Application is ready!"
              break
            fi
            
            echo "⏳ Waiting for application... (attempt $((attempt + 1))/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Application failed to start"
            exit 1
          fi

      - name: Get Authentication Tokens
        id: auth
        run: |
          # Get admin token
          ADMIN_RESPONSE=$(curl -s -X POST ${{ env.BASE_URL }}/users/login \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@practicesoftwaretesting.com","password":"welcome01"}')
          
          # Get regular user token
          USER_RESPONSE=$(curl -s -X POST ${{ env.BASE_URL }}/users/login \
            -H "Content-Type: application/json" \
            -d '{"email":"customer@practicesoftwaretesting.com","password":"welcome01"}')
          
          ADMIN_TOKEN=$(echo $ADMIN_RESPONSE | jq -r '.access_token // empty')
          USER_TOKEN=$(echo $USER_RESPONSE | jq -r '.access_token // empty')
          
          # Validate tokens
          if [ -z "$ADMIN_TOKEN" ] || [ "$ADMIN_TOKEN" = "null" ]; then
            echo "❌ Failed to get admin token"
            echo "Admin response: $ADMIN_RESPONSE"
            exit 1
          fi
          
          if [ -z "$USER_TOKEN" ] || [ "$USER_TOKEN" = "null" ]; then
            echo "❌ Failed to get user token"
            echo "User response: $USER_RESPONSE"
            exit 1
          fi
          
          echo "admin_token=$ADMIN_TOKEN" >> $GITHUB_OUTPUT
          echo "user_token=$USER_TOKEN" >> $GITHUB_OUTPUT

      - name: Run Complete Test Suite
        working-directory: ${{ env.SPRINT_DIR }}
        run: |
          # Create reports directory
          mkdir -p reports
          
          newman run Toolshop_APITesting.postman_collection.json \
            --env-var "baseUrl=${{ env.BASE_URL }}" \
            --env-var "admin_token=${{ steps.auth.outputs.admin_token }}" \
            --env-var "user_token=${{ steps.auth.outputs.user_token }}" \
            --env-var "productId=1" \
            --env-var "userId=2" \
            --env-var "brandId=1" \
            --env-var "otherUserId=3" \
            --reporters cli,html,htmlextra \
            --reporter-html-export "reports/full-regression-report.html" \
            --reporter-htmlextra-export "reports/detailed-full-regression-report.html" \
            --reporter-htmlextra-title "Complete API Regression Test Report" \
            --verbose

      - name: Upload Full Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-regression-test-report
          path: ${{ env.SPRINT_DIR }}/reports/
          retention-days: 30

  cleanup:
    name: Cleanup Environment
    runs-on: ubuntu-latest
    needs: [api-tests, full-regression-test]
    if: always()
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Stop Docker Services
        working-directory: ${{ env.SPRINT_DIR }}
        run: |
          docker compose down -v
          docker system prune -f
